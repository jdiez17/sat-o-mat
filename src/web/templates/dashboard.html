{% extends "base.html" %}

{% block title %}Dashboard - Sat-O-Mat{% endblock %}

{% block content %}
<div class="grid-stack">
    <!-- Timeline Widget -->
    <div class="grid-stack-item" gs-x="0" gs-y="0" gs-w="12" gs-h="4" gs-min-w="6" gs-min-h="3" gs-id="timeline">
        <div class="grid-stack-item-content widget bg-zinc-900 rounded-lg border border-zinc-800 flex flex-col h-full overflow-hidden">
            <div class="grid-drag-handle flex items-center justify-between px-4 py-3 border-b border-zinc-800 cursor-move flex-shrink-0">
                <h2 class="text-lg font-medium">Timeline</h2>
                <button onclick="openNewScheduleModal()"
                        class="px-3 py-1.5 bg-cyan-600 hover:bg-cyan-500 text-white text-sm font-medium rounded transition-colors">
                    + New
                </button>
            </div>
            <div class="widget-content p-4 flex-1 overflow-auto">
                <!-- Timeline - JS renders this -->
                <div id="schedule-timeline">
                    {% include "partials/schedule_timeline.html" %}
                </div>

                <!-- Schedule List - rendered via JS -->
                <div id="schedule-list" class="mt-6">
                    <div class="overflow-x-auto border border-zinc-800 rounded-lg">
                        <div id="schedule-list-root" class="min-h-[120px]">
                            <div class="text-center py-4 text-zinc-500">Connect your API key to load schedules.</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Radio Widget -->
    <div class="grid-stack-item" gs-x="0" gs-y="4" gs-w="12" gs-h="3" gs-min-w="4" gs-min-h="2" gs-id="radio">
        <div class="grid-stack-item-content widget bg-zinc-900 rounded-lg border border-zinc-800 flex flex-col h-full overflow-hidden">
            <div class="grid-drag-handle flex items-center justify-between px-4 py-3 border-b border-zinc-800 cursor-move flex-shrink-0">
                <h2 class="text-lg font-medium">Radio</h2>
                <span class="text-xs text-zinc-500 uppercase tracking-wide">Offline</span>
            </div>
            <div class="widget-content p-4 flex-1 overflow-auto">
                {% include "partials/radio_widget.html" %}
            </div>
        </div>
    </div>

    <!-- Rotator Widget -->
    <div class="grid-stack-item" gs-x="8" gs-y="7" gs-w="4" gs-h="3" gs-min-w="3" gs-min-h="2" gs-id="rotator">
        <div class="grid-stack-item-content widget bg-zinc-900 rounded-lg border border-zinc-800 flex flex-col h-full overflow-hidden">
            <div class="grid-drag-handle flex items-center justify-between px-4 py-3 border-b border-zinc-800 cursor-move flex-shrink-0">
                <h2 class="text-lg font-medium">Rotator</h2>
                <span class="text-xs text-zinc-500 uppercase tracking-wide">Offline</span>
            </div>
            <div class="widget-content p-4 flex-1 overflow-auto">
                {% include "partials/rotator_widget.html" %}
            </div>
        </div>
    </div>
</div>

<!-- New Schedule Modal -->
<div id="schedule-modal" class="hidden fixed inset-0 z-50">
    <div class="absolute inset-0 bg-black/60" onclick="closeNewScheduleModal()"></div>
    <div class="absolute inset-4 md:inset-auto md:top-1/2 md:left-1/2 md:-translate-x-1/2 md:-translate-y-1/2 md:w-[800px] md:max-h-[80vh] bg-zinc-900 rounded-lg border border-zinc-800 flex flex-col">
        {% include "partials/schedule_editor.html" %}
    </div>
</div>

<!-- Schedule Detail Modal -->
<div id="detail-modal" class="hidden fixed inset-0 z-50">
    <div class="absolute inset-0 bg-black/60" onclick="closeDetailModal()"></div>
    <div class="absolute inset-4 md:inset-auto md:top-1/2 md:left-1/2 md:-translate-x-1/2 md:-translate-y-1/2 md:w-[900px] md:max-h-[85vh] bg-zinc-900 rounded-lg border border-zinc-800 flex flex-col">
        <div id="detail-content"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/gridstack@9/dist/gridstack-all.min.js"></script>
<script src="/static/js/dashboard.js"></script>
<script src="/static/js/timeline.js"></script>
<script src="/static/js/editor.js"></script>
<script>
    const WidgetGrid = {
        grid: null,

        init() {
            // Clear any old saved layouts
            localStorage.removeItem('satomat_widget_layout');
            localStorage.removeItem('satomat_widget_layout_v2');

            this.grid = GridStack.init({
                cellHeight: 120,
                margin: 0,
                float: false,
                draggable: {
                    handle: '.grid-drag-handle',
                },
                resizable: {
                    handles: 'all'
                },
            });

            // Listen for resize events to update widgets
            this.grid.on('resizestop', (event, el) => {
                this.onWidgetResized(el);
            });

            // Initial reflow for Timeline
            setTimeout(() => {
                if (window.Timeline && typeof window.Timeline.reflow === 'function') {
                    window.Timeline.reflow();
                }
            }, 100);
        },

        onWidgetResized(el) {
            if (el.querySelector('#timeline-scroll-container')) {
                if (window.Timeline && typeof window.Timeline.reflow === 'function') {
                    window.Timeline.reflow();
                }
            }
        },
    };

    document.addEventListener('DOMContentLoaded', () => WidgetGrid.init());
    window.WidgetGrid = WidgetGrid;
</script>
{% endblock %}
