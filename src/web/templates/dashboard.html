{% extends "base.html" %}

{% block title %}Dashboard - Sat-O-Mat{% endblock %}

{% block content %}
<div class="grid-stack">
    <!-- Timeline Widget -->
    <div class="grid-stack-item" gs-x="0" gs-y="0" gs-w="12" gs-h="4" gs-min-w="6" gs-min-h="3" gs-id="timeline">
        <div class="grid-stack-item-content widget bg-zinc-900 rounded-lg border border-zinc-800 flex flex-col h-full overflow-hidden">
            <div class="grid-drag-handle flex items-center justify-between px-4 py-3 border-b border-zinc-800 cursor-move flex-shrink-0">
                <div class="flex items-center gap-2">
                    <a href="/timeline" title="Full screen"
                       class="p-1.5 text-zinc-400 hover:text-zinc-200 hover:bg-zinc-800 rounded transition-colors">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"/>
                        </svg>
                    </a>
                    <h2 class="text-lg font-medium">Timeline</h2>
                </div>
                <button @click="$store.schedules.openEditor()"
                        class="px-3 py-1.5 bg-cyan-600 hover:bg-cyan-500 text-white text-sm font-medium rounded transition-colors">
                    + New
                </button>
            </div>
            <div class="widget-content p-4 flex-1 overflow-auto">
                {% include "partials/timeline_list.html" %}
            </div>
        </div>
    </div>

    <!-- Radio Widget -->
    <div class="grid-stack-item" gs-x="0" gs-y="4" gs-w="12" gs-h="3" gs-min-w="4" gs-min-h="2" gs-id="radio">
        <div class="grid-stack-item-content widget bg-zinc-900 rounded-lg border border-zinc-800 flex flex-col h-full overflow-hidden">
            <div class="grid-drag-handle flex items-center justify-between px-4 py-3 border-b border-zinc-800 cursor-move flex-shrink-0">
                <h2 class="text-lg font-medium">Radio</h2>
                <span class="text-xs text-zinc-500 uppercase tracking-wide">Offline</span>
            </div>
            <div class="widget-content p-4 flex-1 overflow-auto">
                {% include "partials/radio_widget.html" %}
            </div>
        </div>
    </div>

    <!-- Rotator Widget -->
    <div class="grid-stack-item" gs-x="8" gs-y="7" gs-w="4" gs-h="3" gs-min-w="3" gs-min-h="2" gs-id="rotator">
        <div class="grid-stack-item-content widget bg-zinc-900 rounded-lg border border-zinc-800 flex flex-col h-full overflow-hidden">
            <div class="grid-drag-handle flex items-center justify-between px-4 py-3 border-b border-zinc-800 cursor-move flex-shrink-0">
                <h2 class="text-lg font-medium">Rotator</h2>
                <span class="text-xs text-zinc-500 uppercase tracking-wide">Offline</span>
            </div>
            <div class="widget-content p-4 flex-1 overflow-auto">
                {% include "partials/rotator_widget.html" %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/gridstack@9/dist/gridstack-all.min.js"></script>
<script>
    const WidgetGrid = {
        grid: null,

        init() {
            // Clear any old saved layouts
            localStorage.removeItem('satomat_widget_layout');
            localStorage.removeItem('satomat_widget_layout_v2');

            this.grid = GridStack.init({
                cellHeight: 120,
                margin: 0,
                float: false,
                draggable: {
                    handle: '.grid-drag-handle',
                },
                resizable: {
                    handles: 'all'
                },
            });

            // Listen for resize events to update widgets
            this.grid.on('resizestop', (event, el) => {
                this.onWidgetResized(el);
            });
        },

        onWidgetResized(el) {
            // Find timeline component and trigger reflow
            const timelineEl = el.querySelector('[x-data*="timeline"]');
            if (timelineEl && window.Alpine) {
                // Alpine 3 API: use Alpine.$data() to access component data
                const data = Alpine.$data(timelineEl);
                if (data && data.reflow) {
                    data.reflow();
                }
            }
        },

        resetLayout() {
            // Reset to default layout
            location.reload();
        },
    };

    document.addEventListener('DOMContentLoaded', () => WidgetGrid.init());
    window.WidgetGrid = WidgetGrid;
</script>
{% endblock %}
